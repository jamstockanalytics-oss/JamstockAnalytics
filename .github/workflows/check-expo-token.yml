name: Check EXPO_TOKEN Status

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-expo-token:
    runs-on: ubuntu-latest
    name: EXPO_TOKEN Status Check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check EXPO_TOKEN status
        run: npm run check-expo-token
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Validate EXPO_TOKEN
        run: npm run validate-expo-token
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Generate EXPO_TOKEN report
        run: npm run expo-token-report
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Check token permissions
        run: |
          echo "ðŸ” Checking EXPO_TOKEN permissions..."
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN is not set"
            exit 1
          fi
          
          if npx expo whoami > /dev/null 2>&1; then
            echo "âœ… EXPO_TOKEN is valid"
            USERNAME=$(npx expo whoami)
            echo "Logged in as: $USERNAME"
          else
            echo "âŒ EXPO_TOKEN is invalid"
            exit 1
          fi
          
          # Check if token has required permissions
          if npx expo projects:list --limit 1 > /dev/null 2>&1; then
            echo "âœ… Token has required permissions"
          else
            echo "âš ï¸  Token permissions check failed"
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Test Expo CLI commands
        run: |
          echo "ðŸ” Testing Expo CLI commands..."
          
          # Test basic commands
          npx expo --version
          npx expo whoami
          
          # Test project commands
          npx expo projects:list --limit 5
          
          echo "âœ… All Expo CLI commands working correctly"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Generate status summary
        run: |
          echo "ðŸ“Š EXPO_TOKEN Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "============================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$EXPO_TOKEN" ]; then
            echo "âŒ EXPO_TOKEN is not set" >> $GITHUB_STEP_SUMMARY
            echo "Please configure EXPO_TOKEN in repository secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… EXPO_TOKEN is configured" >> $GITHUB_STEP_SUMMARY
            
            if npx expo whoami > /dev/null 2>&1; then
              USERNAME=$(npx expo whoami)
              echo "âœ… Token is valid" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ‘¤ Logged in as: $USERNAME" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Token is invalid" >> $GITHUB_STEP_SUMMARY
            fi
            
            if npx expo projects:list --limit 1 > /dev/null 2>&1; then
              echo "âœ… Token has required permissions" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸  Token permissions check failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ To fix issues:" >> $GITHUB_STEP_SUMMARY
          echo "1. Set EXPO_TOKEN in repository secrets" >> $GITHUB_STEP_SUMMARY
          echo "2. Ensure token is valid and not expired" >> $GITHUB_STEP_SUMMARY
          echo "3. Check token permissions in Expo dashboard" >> $GITHUB_STEP_SUMMARY
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
