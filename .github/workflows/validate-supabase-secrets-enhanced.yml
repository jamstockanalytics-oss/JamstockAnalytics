name: Enhanced Supabase Secrets Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    name: Enhanced Secrets Validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive validation
        run: npm run validate-comprehensive
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXPO_PUBLIC_DEEPSEEK_API_KEY: ${{ secrets.EXPO_PUBLIC_DEEPSEEK_API_KEY }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          DEEPSEEK_TEMPERATURE: ${{ secrets.DEEPSEEK_TEMPERATURE }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          RATE_LIMIT: ${{ secrets.RATE_LIMIT }}
          WINDOW_MS: ${{ secrets.WINDOW_MS }}
          MAX_MESSAGES: ${{ secrets.MAX_MESSAGES }}
          CLEANUP_DAYS: ${{ secrets.CLEANUP_DAYS }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Run environment validation
        run: npm run validate-env
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXPO_PUBLIC_DEEPSEEK_API_KEY: ${{ secrets.EXPO_PUBLIC_DEEPSEEK_API_KEY }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          DEEPSEEK_TEMPERATURE: ${{ secrets.DEEPSEEK_TEMPERATURE }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          RATE_LIMIT: ${{ secrets.RATE_LIMIT }}
          WINDOW_MS: ${{ secrets.WINDOW_MS }}
          MAX_MESSAGES: ${{ secrets.MAX_MESSAGES }}
          CLEANUP_DAYS: ${{ secrets.CLEANUP_DAYS }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Run secrets validation
        run: npm run validate-secrets-advanced
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXPO_PUBLIC_DEEPSEEK_API_KEY: ${{ secrets.EXPO_PUBLIC_DEEPSEEK_API_KEY }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          DEEPSEEK_TEMPERATURE: ${{ secrets.DEEPSEEK_TEMPERATURE }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          RATE_LIMIT: ${{ secrets.RATE_LIMIT }}
          WINDOW_MS: ${{ secrets.WINDOW_MS }}
          MAX_MESSAGES: ${{ secrets.MAX_MESSAGES }}
          CLEANUP_DAYS: ${{ secrets.CLEANUP_DAYS }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Run configuration validation
        run: npm run validate-config
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXPO_PUBLIC_DEEPSEEK_API_KEY: ${{ secrets.EXPO_PUBLIC_DEEPSEEK_API_KEY }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          DEEPSEEK_TEMPERATURE: ${{ secrets.DEEPSEEK_TEMPERATURE }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          RATE_LIMIT: ${{ secrets.RATE_LIMIT }}
          WINDOW_MS: ${{ secrets.WINDOW_MS }}
          MAX_MESSAGES: ${{ secrets.MAX_MESSAGES }}
          CLEANUP_DAYS: ${{ secrets.CLEANUP_DAYS }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Run legacy validation (backward compatibility)
        run: npm run validate-secrets
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXPO_PUBLIC_DEEPSEEK_API_KEY: ${{ secrets.EXPO_PUBLIC_DEEPSEEK_API_KEY }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          DEEPSEEK_TEMPERATURE: ${{ secrets.DEEPSEEK_TEMPERATURE }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          PORT: ${{ secrets.PORT }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          RATE_LIMIT: ${{ secrets.RATE_LIMIT }}
          WINDOW_MS: ${{ secrets.WINDOW_MS }}
          MAX_MESSAGES: ${{ secrets.MAX_MESSAGES }}
          CLEANUP_DAYS: ${{ secrets.CLEANUP_DAYS }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Generate validation report
        run: |
          echo "ðŸ” Enhanced Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Comprehensive validation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Environment validation passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Secrets validation passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Configuration validation passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Legacy validation passed (backward compatibility)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ All validation checks passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY
